name: ART_Kulinariya

on:
  push:
    branches: [ master ]

jobs:
  validate:
    name: Validate ART_Kulinariya
    runs-on: ubuntu-latest
    steps:
     - name: Checkout repository
       uses: actions/checkout@v6

     - name: Set up Python
       uses: actions/setup-python@v6
       with:
         python-version: '3.11'

     - name: Create venv and install libs
       run: |
        python -m venv .venv
        source .venv/bin/activate
        pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; else pip install "django>=5.2,<5.3"; fi
        pip install "flake8>=7,<8" "pip-audit>=2,<3"

     - name: Check Djaango settings
       run: |
        source .venv/bin/activate
        mkdir -p artifacts/functional
        python manage.py check > artifacts/functional/django-check.log
        python manage.py makemigrations --check --dry-run > artifacts/functional/migrations-check.log

     - name: Run tests
       run: |
        source .venv/bin/activate
        mkdir -p artifacts/tests
        python manage.py test -v 2 > artifacts/tests/tests.log

     - name: Lint code
       run: |
        source .venv/bin/activate
        flake8 > artifacts/lint/flake8.log 2>&1

  test:
    name: Test ART_Kulinariya
    runs-on: ubuntu-latest
    steps:
     - name: Checkout repository
       uses: actions/checkout@v6

     - name: Set up Python
       uses: actions/setup-python@v6
       with:
         python-version: '3.11'

     - name: Create venv and install libs
       run: |
        python -m venv .venv
        source .venv/bin/activate
        pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; else pip install "django>=5.2,<5.3"; fi
        pip install "flake8>=7,<8" "pip-audit>=2,<3"

     - name: Run tests
       run: |
        source .venv/bin/activate
        mkdir -p artifacts/tests
        python manage.py test -v 2 > artifacts/tests/tests.log