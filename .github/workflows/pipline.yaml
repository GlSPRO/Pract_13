name: ART_Kulinariya

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build_project:
    name: build_project
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Create venv and install libs
        run: |
          python -m venv .venv
          source .venv/bin/activate
          python --version
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; else pip install "django>=5.2,<5.3"; fi
          pip install "flake8>=7,<8" "pip-audit>=2,<3"

      - name: Build artifacts dir
        run: |
          mkdir -p artifacts/build
          echo "Build stage completed: $(date -u +'%Y-%m-%dT%H:%M:%SZ')" > artifacts/build/build-info.txt

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: artifacts/build/
          if-no-files-found: warn

  lint_python:
    name: lint_python
    runs-on: ubuntu-latest
    continue-on-error: true
    needs: build_project
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Create venv and install libs
        run: |
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; else pip install "django>=5.2,<5.3"; fi
          pip install "flake8>=7,<8" "pip-audit>=2,<3"

      - name: Run flake8
        run: |
          source .venv/bin/activate
          mkdir -p artifacts/lint
          flake8 . --exclude=.venv,__pycache__,migrations > artifacts/lint/flake8.log 2>&1 || true

      - name: Upload lint artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lint-artifacts
          path: artifacts/lint/
          if-no-files-found: warn

  functional_django_checks:
    name: functional_django_checks
    runs-on: ubuntu-latest
    needs: build_project
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Create venv and install libs
        run: |
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; else pip install "django>=5.2,<5.3"; fi
          pip install "flake8>=7,<8" "pip-audit>=2,<3"

      - name: Run Django checks
        run: |
          source .venv/bin/activate
          mkdir -p artifacts/functional
          python manage.py check > artifacts/functional/django-check.log
          python manage.py makemigrations --check --dry-run > artifacts/functional/migrations-check.log

      - name: Upload functional artifacts
        uses: actions/upload-artifact@v4
        with:
          name: functional-artifacts
          path: artifacts/functional/
          if-no-files-found: warn

  functional_tests:
    name: functional_tests
    runs-on: ubuntu-latest
    needs: build_project
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Create venv and install libs
        run: |
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; else pip install "django>=5.2,<5.3"; fi
          pip install "flake8>=7,<8" "pip-audit>=2,<3"

      - name: Run tests
        run: |
          source .venv/bin/activate
          mkdir -p artifacts/tests
          python manage.py test -v 2 > artifacts/tests/tests.log

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tests-artifacts
          path: artifacts/tests/
          if-no-files-found: warn

  security_dependencies_audit:
    name: security_dependencies_audit
    runs-on: ubuntu-latest
    continue-on-error: true
    needs: build_project
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Create venv and install libs
        run: |
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; else pip install "django>=5.2,<5.3"; fi
          pip install "flake8>=7,<8" "pip-audit>=2,<3"

      - name: Run pip-audit
        run: |
          source .venv/bin/activate
          mkdir -p artifacts/security
          if [ -f requirements.txt ]; then
            pip-audit -r requirements.txt > artifacts/security/pip-audit.log || true
          else
            echo "requirements.txt not found, skipping pip-audit" > artifacts/security/pip-audit.log
          fi

      - name: Upload security artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-artifacts
          path: artifacts/security/
          if-no-files-found: warn
