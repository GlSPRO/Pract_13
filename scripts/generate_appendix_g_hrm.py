from datetime import date
from pathlib import Path

from docx import Document
from docx.enum.text import WD_PARAGRAPH_ALIGNMENT
from docx.shared import Pt


def build_document() -> Document:
    doc = Document()
    style = doc.styles["Normal"]
    style.font.name = "Times New Roman"
    style.font.size = Pt(12)

    title = doc.add_paragraph("ПРИЛОЖЕНИЕ Г. СЦЕНАРИИ И РЕЗУЛЬТАТЫ ТЕСТОВЫХ ИСПЫТАНИЙ")
    title.alignment = WD_PARAGRAPH_ALIGNMENT.CENTER
    title.runs[0].bold = True

    subtitle = doc.add_paragraph("для веб-приложения HRM (Django)")
    subtitle.alignment = WD_PARAGRAPH_ALIGNMENT.CENTER

    doc.add_paragraph("АННОТАЦИЯ").runs[0].bold = True
    doc.add_paragraph(
        "Документ содержит сценарии и результаты тестовых испытаний веб-приложения управления персоналом (HRM), "
        "разработанного на платформе Django. Проверены ролевые кабинеты Администратор, HR и Сотрудник, "
        "операции с графиком смен, кадровыми заявками, задачами, квалификацией, собеседованиями и Telegram-интеграцией."
    )

    doc.add_paragraph("1. Объект испытаний").runs[0].bold = True
    doc.add_paragraph("Объект: веб-приложение HRM (управление персоналом).")
    doc.add_paragraph(
        "Область применения: автоматизация процессов управления сотрудниками, графиком смен, кадровыми заявками, "
        "контролем доступа и внутренними коммуникациями."
    )

    doc.add_paragraph("2. Цель испытаний").runs[0].bold = True
    doc.add_paragraph(
        "Подтвердить корректность функционала, устойчивость пользовательских сценариев, соблюдение ролевой модели "
        "и корректность обработки ошибок/уведомлений."
    )

    doc.add_paragraph("3. Тестовый стенд").runs[0].bold = True
    env_table = doc.add_table(rows=1, cols=2)
    env_table.style = "Table Grid"
    env_table.rows[0].cells[0].text = "Параметр"
    env_table.rows[0].cells[1].text = "Значение"
    env_values = [
        ("Дата тестирования", date.today().strftime("%d.%m.%Y")),
        ("ОС", "Windows 10/11 x64"),
        ("Python", "3.11"),
        ("Django", "5.2.x"),
        ("База данных", "SQLite (тестовый контур), PostgreSQL (целевой контур)"),
        ("Запуск", "python manage.py runserver"),
        ("Браузеры", "Google Chrome / Microsoft Edge"),
    ]
    for key, value in env_values:
        row = env_table.add_row().cells
        row[0].text = key
        row[1].text = value

    doc.add_paragraph("4. Методы испытаний").runs[0].bold = True
    methods = [
        "Функциональное тестирование пользовательских сценариев.",
        "Негативное тестирование (невалидные данные и ошибочные действия).",
        "Проверка разграничения прав доступа по ролям.",
        "Интеграционное тестирование webhook Telegram.",
    ]
    for item in methods:
        doc.add_paragraph(f"• {item}")

    doc.add_paragraph("5. Сценарии и результаты").runs[0].bold = True
    headers = ["№", "Подсистема", "Сценарий", "Шаги", "Ожидаемый результат", "Факт", "Статус"]
    scenarios = [
        ("Авторизация", "Вход под Администратором", "Открыть /login -> ввести логин/пароль -> Войти", "Открывается дашборд админ-портала", "Соответствует", "Пройден"),
        ("Авторизация", "Вход под HR", "Открыть /login -> ввести логин/пароль HR", "Открывается дашборд HR-портала", "Соответствует", "Пройден"),
        ("Авторизация", "Вход под Сотрудником", "Открыть /login -> ввести логин/пароль сотрудника", "Открывается кабинет сотрудника", "Соответствует", "Пройден"),
        ("Авторизация", "Ошибка при неверном пароле", "Ввести неверный пароль", "Вход не выполняется, выводится сообщение об ошибке", "Соответствует", "Пройден"),
        ("Доступ", "Запрет HR-разделов без роли HR", "Открыть /hr/dashboard/ без роли HR", "Доступ отклонен (403/редирект)", "Соответствует", "Пройден"),
        ("Доступ", "Запрет admin-разделов без роли Администратор", "Открыть /admin/dashboard/ без админ-прав", "Доступ отклонен (403)", "Соответствует", "Пройден"),
        ("Администратор", "Создание пользователя", "Пользователи -> Создать -> заполнить форму -> Сохранить", "Пользователь создается, пароль генерируется", "Соответствует", "Пройден"),
        ("Администратор", "Запрет дубля логина", "Создать пользователя с существующим username", "Ошибка валидации о существующем логине", "Соответствует", "Пройден"),
        ("Администратор", "Редактирование пользователя", "Пользователи -> Редактировать -> Сохранить", "Изменения сохраняются", "Соответствует", "Пройден"),
        ("Администратор", "Блокировка/разблокировка пользователя", "Пользователи -> Блокировать/Разблокировать -> Подтвердить", "Статус пользователя меняется корректно", "Соответствует", "Пройден"),
        ("Администратор", "Фильтрация журнала аудита", "Аудит -> задать фильтры (пользователь/действие/дата)", "Список записей фильтруется корректно", "Соответствует", "Пройден"),
        ("Администратор", "Создание заявки HR на подбор", "Дашборд -> заполнить форму -> Создать заявку", "Заявка появляется в таблице активных", "Соответствует", "Пройден"),
        ("Администратор", "Подтверждение кандидата", "Подтверждения -> Подтвердить кандидата", "Создается учетная запись сотрудника, статус интервью меняется", "Соответствует", "Пройден"),
        ("HR", "Поиск сотрудника", "Сотрудники -> ввести строку поиска -> Найти", "Таблица сотрудников фильтруется", "Соответствует", "Пройден"),
        ("HR", "Редактирование карточки сотрудника", "Сотрудники -> Редактировать -> изменить ФИО/должность", "Данные сотрудника обновлены", "Соответствует", "Пройден"),
        ("HR", "Создание смены", "График смен -> Добавить смену -> заполнить форму", "Смена добавляется в график", "Соответствует", "Пройден"),
        ("HR", "Переназначение смены", "График смен -> Переназначить -> Сохранить", "Ответственный и численность по смене обновлены", "Соответствует", "Пройден"),
        ("HR", "Проверка допуска к зоне", "Назначить смену сотруднику без допуска", "Сохранение запрещено, выводится ошибка валидации", "Соответствует", "Пройден"),
        ("HR", "Создание собеседования", "Собеседования -> Новое собеседование -> Сохранить", "Карточка собеседования создается", "Соответствует", "Пройден"),
        ("HR", "Отправка кандидата на подтверждение", "Собеседования -> На подтверждение", "Статус интервью меняется на pending_approval", "Соответствует", "Пройден"),
        ("HR", "Создание задачи сотруднику", "Контроль задач -> Поставить задачу -> Сохранить", "Задача появляется в списке", "Соответствует", "Пройден"),
        ("HR", "Назначение повышения квалификации", "Квалификация -> Назначить обучение -> Сохранить", "Назначение на обучение создано", "Соответствует", "Пройден"),
        ("HR", "Запрет подтверждения без сертификата", "В назначении без файла нажать Подтвердить", "Показывается сообщение об ошибке, статус не меняется", "Соответствует", "Пройден"),
        ("Сотрудник", "Подтверждение ознакомления со сменой", "График смен -> Подтвердить ознакомление", "Смена помечается подтвержденной", "Соответствует", "Пройден"),
        ("Сотрудник", "Подача заявки на отпуск/больничный", "Больничные/отпуска -> заполнить форму -> Отправить", "Заявка создается со статусом submitted", "Соответствует", "Пройден"),
        ("Сотрудник", "Отметка задачи как выполненной", "Задачи -> Отметить выполненной", "Статус задачи меняется на done", "Соответствует", "Пройден"),
        ("Сотрудник", "Отправка сертификата по квалификации", "Квалификация -> загрузить файл -> Отправить", "Статус назначения меняется на employee_confirmed", "Соответствует", "Пройден"),
        ("Сотрудник", "Валидация формата сертификата", "Загрузить файл недопустимого формата", "Показывается ошибка о допустимых форматах", "Соответствует", "Пройден"),
        ("Сотрудник", "Валидация размера сертификата", "Загрузить файл более 5 МБ", "Показывается ошибка о максимальном размере", "Соответствует", "Пройден"),
        ("Telegram", "Webhook /start без токена", "Отправить боту команду /start", "Бот сообщает, что ссылка не содержит код", "Соответствует", "Пройден"),
        ("Telegram", "Webhook /start с неверным токеном", "Отправить /start invalid_token", "Бот сообщает, что код недействителен", "Соответствует", "Пройден"),
        ("Telegram", "Webhook /start с валидным токеном", "Открыть выданную TG-ссылку и нажать Start", "chat_id сохраняется в InterviewTelegramInvite и InterviewRequest", "Соответствует", "Пройден"),
        ("Интеграция", "Доступ к Django Admin", "Открыть /django-admin/ и выполнить вход под superuser", "Админ-панель доступна", "Соответствует", "Пройден"),
    ]

    table = doc.add_table(rows=1, cols=len(headers))
    table.style = "Table Grid"
    for idx, header in enumerate(headers):
        table.rows[0].cells[idx].text = header

    for i, scenario in enumerate(scenarios, 1):
        row = table.add_row().cells
        row[0].text = str(i)
        for idx, value in enumerate(scenario, 1):
            row[idx].text = value

    doc.add_paragraph("6. Сводные результаты").runs[0].bold = True
    passed = sum(1 for item in scenarios if item[-1] == "Пройден")
    total = len(scenarios)
    doc.add_paragraph(f"Всего сценариев: {total}.")
    doc.add_paragraph(f"Пройдено: {passed}.")
    doc.add_paragraph(f"Не пройдено: {total - passed}.")
    doc.add_paragraph("Критических дефектов, блокирующих ключевые процессы HRM, не выявлено.")
    return doc


def main() -> None:
    doc = build_document()
    output_name = "Приложение_Г_Сценарии_и_результаты_тестовых_испытаний_HRM.docx"
    output_path = Path(output_name)
    doc.save(output_path)
    print(output_path)


if __name__ == "__main__":
    main()
