stages:
  - build
  - lint
  - functional

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PYTHONUNBUFFERED: "1"

cache:
  paths:
    - .cache/pip

before_script:
  - python --version
  - python -m pip install --upgrade pip
  - if [ -f requirements.txt ]; then pip install -r requirements.txt; else pip install "django>=5.2,<5.3"; fi
  - pip install "flake8>=7,<8"

build_project:
  stage: build
  script:
    - mkdir -p artifacts/build
    - python -m compileall -q manage.py hrm core admin_portal hr_portal > artifacts/build/compileall.log 2>&1
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - artifacts/build/

lint_python:
  stage: lint
  script:
    - mkdir -p artifacts/lint
    - flake8 . --exclude=.venv,__pycache__,migrations > artifacts/lint/flake8.log
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - artifacts/lint/

tests_unit_integration:
  stage: functional
  script:
    - mkdir -p artifacts/tests
    - python manage.py check > artifacts/tests/django-check.log
    - python manage.py makemigrations --check --dry-run > artifacts/tests/migrations-check.log
    - python manage.py test core admin_portal hr_portal -v 2 > artifacts/tests/unit-tests.log
    - python manage.py test -v 2 > artifacts/tests/integration-tests.log
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - artifacts/tests/

functional_migrations_report:
  stage: functional
  script:
    - mkdir -p artifacts/migrations
    - python manage.py makemigrations --check --dry-run > artifacts/migrations/migrations-check.log
    - python manage.py showmigrations > artifacts/migrations/showmigrations.log
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - artifacts/migrations/
